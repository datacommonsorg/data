import pandas as pd
import os
import glob
import re
import shutil
from absl import logging, app

def main(argv):
    del argv  # Unused

    source_folder = "source_files"
    files = glob.glob(os.path.join(source_folder, "SVI_*_US_county.csv"))

    if not files:
        logging.warning("No matching files found.")
        return

    logging.info(f"Found {len(files)} files to process.")

    for file_path in files:
        filename = os.path.basename(file_path)
        logging.info(f"Processing file: {filename}")

        match = re.search(r"SVI_(\d{4})_US_county\.csv", filename)
        if not match:
            logging.warning(f"Year not found in filename: {filename}")
            continue

        year = int(match.group(1))

        if year == 2010:
            try:
                os.makedirs(os.path.join(source_folder, "2010"), exist_ok=True)
                shutil.move(file_path, os.path.join(source_folder, "2010", filename))
                logging.info(f"Moved 2010 file to source_files/2010/")
            except Exception as e:
                logging.error(f"Failed to move 2010 file: {e}")
            continue

        try:
            df = pd.read_csv(file_path)
            df["year"] = year
            df.to_csv(file_path, index=False)
            logging.info(f"Added year={year} to {filename}")
        except Exception as e:
            logging.error(f"Failed to process file {filename}: {e}")

if __name__ == "__main__":
    app.run(main)
