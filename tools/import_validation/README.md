# Import Validation Framework

This document describes how to use the Import Validation Framework to run a series of automated checks on data imports.

## Overview

The framework is designed to be a flexible and extensible tool for ensuring the quality and consistency of data before it is imported. It operates on summary files generated by other import tools, such as a statistics summary and a differ output summary.

## Running the Framework

The main entry point for the framework is `import_validation.py`. It is a command-line tool that takes a configuration file and the paths to the summary data files as input.

### Usage

```bash
python3 -m tools.import_validation.import_validation \
    --validation_config=<path_to_your_config.json> \
    --stats_summary=<path_to_your_stats_summary.csv> \
    --differ_output=<path_to_your_differ_output.csv> \
    --validation_output=<path_for_your_output.csv>
```

- `--validation_config`: Path to the JSON file that defines which validations to run.
- `--stats_summary`: Path to the CSV file containing summary statistics of the import (e.g., `summary_report.csv`).
- `--differ_output`: Path to the CSV file containing the output of a differ tool (e.g., `point_analysis_summary.csv`).
- `--validation_output`: Path where the output report of the validation will be saved.

The script will exit with a status code of `1` if any validation fails, and `0` on success.

## Configuration

The behavior of the validation framework is controlled by a JSON configuration file. This file contains a list of validation objects, where each object defines a specific check to be performed.

### Example Configuration

```json
[
    {
        "validation": "MAX_DATE_LATEST"
    },
    {
        "validation": "DELETED_COUNT",
        "threshold": 0
    },
    {
        "validation": "MAX_VALUE_CHECK",
        "name": "Check for values over 100 in Percent StatVars",
        "maximum": 100,
        "variableMeasured": [
            ".*Percent.*"
        ]
    },
    {
        "validation": "MAX_VALUE_CHECK",
        "name": "Check for values over 1000 in Count_Person",
        "maximum": 1000,
        "variableMeasured": [
            "Count_Person"
        ]
    }
]
```

### Supported Validations

The following validations are currently supported:

| Validation Name           | Description                                                              | Required Data     | Configuration Parameters                               |
| ------------------------- | ------------------------------------------------------------------------ | ----------------- | ------------------------------------------------------ |
| `MAX_DATE_LATEST`         | Checks that the latest date in the data is from the current year.        | `stats_summary`   | None                                                   |
| `MAX_DATE_CONSISTENT`     | Checks that the latest date is the same for all StatVars.                | `stats_summary`   | None                                                   |
| `DELETED_COUNT`           | Checks that the total number of deleted points is within a threshold.    | `differ_output`   | `threshold` (integer, defaults to 0)                   |
| `MODIFIED_COUNT`          | Checks that the number of modified points is the same for all StatVars.  | `differ_output`   | None                                                   |
| `ADDED_COUNT`             | Checks that the number of added points is the same for all StatVars.     | `differ_output`   | None                                                   |
| `UNMODIFIED_COUNT`        | Checks that the number of unmodified points is the same for all StatVars. | `differ_output`   | None                                                   |
| `NUM_PLACES_CONSISTENT`   | Checks that the number of places is the same for all StatVars.           | `stats_summary`   | None                                                   |
| `NUM_PLACES_COUNT`        | Checks that the number of places is within a defined range.              | `stats_summary`   | `minimum`, `maximum`, or `value` (integer)             |
| `NUM_OBSERVATIONS_CHECK`  | Checks that the number of observations is within a defined range.        | `stats_summary`   | `minimum`, `maximum`, or `value` (integer)             |
| `UNIT_CONSISTENCY_CHECK`  | Checks that the unit is the same for all StatVars.                       | `stats_summary`   | None                                                   |
| `MIN_VALUE_CHECK`         | Checks that the minimum value is not below a defined minimum.            | `stats_summary`   | `minimum` (integer or float)                           |
| `MAX_VALUE_CHECK`         | Checks that the maximum value is not above a defined maximum.            | `stats_summary`   | `maximum` (integer or float)                           |

### Filtering by StatVar

All validations can be applied to a subset of StatVars by adding a `variableMeasured` key to the validation object. This key takes a list of strings, which can be:

- **An exact StatVar DCID:** e.g., `"Count_Person"`
- **A regular expression:** e.g., `".*Percent.*"` to match all StatVars containing the word "Percent".

**Note:** Filtering by property-value dictionaries is not yet fully supported.

## Output

The framework generates a CSV file (`validation_output.csv` by default) with the results of each validation. The file contains the following columns:

- `test`: The name of the validation that was run.
- `status`: The result of the validation (`PASSED`, `FAILED`, `CONFIG_ERROR`, or `DATA_ERROR`).
- `message`: A human-readable message describing the outcome.
- `details`: A JSON string containing detailed context, especially on failures.
