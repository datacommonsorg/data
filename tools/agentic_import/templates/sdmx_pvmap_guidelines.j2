### SDMX PVMap Generation Guidelines

#### Constraint-Based Code Selection for PV Maps

1. **Constraint-Based Code Selection**:
   * **CRITICAL**: Check for `<structure:Constraints>` in metadata FIRST
   * If constraints exist, map ONLY the code values specified in constraints (not entire codelist)
   * If no constraints, use full codelist but sample data to verify which codes actually appear
   * This optimization prevents creating unnecessary mappings and reduces processing time

2. **Language Priority for PV Generation**:
   * When multiple languages exist (xml:lang attributes), prioritize English ("en")
   * If English unavailable, select any available language consistently
   * Use `#Eval` with string manipulation if needed to handle multi-language labels

3. **Semantic Context Building**:
   * Combine dataflow name + dimension names + code descriptions to generate meaningful StatVar names
   * Use concept descriptions to determine appropriate Data Commons properties
   * Store metadata in comments or use for generating descriptive StatVar names
   * Example: "Central Bank Policy Rates" + "Monthly" + "Argentina" â†’ helps map to appropriate properties

#### PV Map Syntax for SDMX Mappings

**Standard Dimension PV Examples**:
* REF_AREA: `{Data},observationAbout,country/{Data}` or `USA,observationAbout,country/USA`
* TIME_PERIOD: `{Data},observationDate,{Data}`
* FREQ: `A,observationPeriod,P1Y`, `Q,observationPeriod,P3M`, `M,observationPeriod,P1M`
* OBS_VALUE: `OBS_VALUE,value,{Number}`

**Time Period Conversions**:
* Quarterly to month end: `TIME_PERIOD,#Regex,"^(?P<Year>[0-9]{4})-Q(?P<Quarter>[1-4])$",#Eval,"observationDate='{Year}-' + str(int({Quarter})*3).zfill(2)"`

**Attribute PV Examples**:
* UNIT_MEASURE: `USD,unit,USDollar`, `EUR,unit,Euro`, `PERCENT,unit,Percent`
* UNIT_MULT: `3,scalingFactor,1000` (thousands), `6,scalingFactor,1000000` (millions)
* OBS_STATUS: `E,measurementMethod,Estimated`, `P,measurementMethod,Provisional`

**Observation Status Handling**:
* Missing values: `OBS_STATUS:M,MissingValue,''` (skip cell value)
* Not applicable: `OBS_STATUS:NA,NotApplicable,''` (skip cell value)

**Hierarchical Codes**:
```
A,economicActivity,Agriculture
A01,economicActivity,CropProduction
```

**Multiple Indicators**:
```
GDP,measuredProperty,grossDomesticProduct,populationType,EconomicActivity
INFLATION,measuredProperty,inflationRate,populationType,EconomicActivity,statType,growthRate
```

#### Data Processing Rules

1. **Column Selection**: Specify relevant columns in metadata configuration to optimize processing:
   * Add `input_columns,"REF_AREA,TIME_PERIOD,OBS_VALUE,UNIT_MEASURE"` to focus on essential columns
   * Exclude metadata or auxiliary columns that don't contribute to StatVars

2. **Preserve Dimension Combinations**: Ensure each unique combination of dimensions maps to a distinct StatisticalVariable

3. **Handle Missing Values**: Use `#Filter` or `#ignore` for SDMX missing value codes (M, NA, ":", "-")

4. **Frequency Alignment**: When mixing frequencies, ensure proper date formatting:
   * Annual: YYYY
   * Quarterly: YYYY-MM (using last month of quarter)
   * Monthly: YYYY-MM
   * Daily: YYYY-MM-DD

5. **Version Management**: For datasets with revisions, use `measurementMethod` to indicate revision status

### Example SDMX PV Map

#### CSV Format:
```csv
key,property1,value1,property2,value2,property3,value3

# Note: Put processor configuration (e.g., input_columns) in metadata.csv, not here

# Dataflow identification
ECB:EXR,populationType,CurrencyExchange,,,,

# Frequency dimension
D,observationPeriod,P1D,,,,
M,observationPeriod,P1M,,,,
A,observationPeriod,P1Y,,,,
Q,observationPeriod,P3M,,,,
W,observationPeriod,P1W,,,,

# Currency dimensions  
USD,measuredProperty,exchangeRate,fromCurrency,Euro,toCurrency,USDollar
GBP,measuredProperty,exchangeRate,fromCurrency,Euro,toCurrency,BritishPound
JPY,measuredProperty,exchangeRate,fromCurrency,Euro,toCurrency,JapaneseYen

# Reference area
REF_AREA,observationAbout,{Data},,,,
# Or for specific country codes
USA,observationAbout,country/USA,,,,
DEU,observationAbout,country/DEU,,,,
FRA,observationAbout,country/FRA,,,,

# Time period
TIME_PERIOD,observationDate,{Data},,,,

# Observation value
OBS_VALUE,value,{Number},,,,

# Unit of measure
PURE_NUMB,unit,Number,,,,
PERCENT,unit,Percent,,,,
INDEX,unit,Index,,,,
USD,unit,USDollar,,,,
EUR,unit,Euro,,,,

# Unit multipliers
0,scalingFactor,1,,,,
3,scalingFactor,1000,,,,
6,scalingFactor,1000000,,,,
9,scalingFactor,1000000000,,,,

# Observation status
A,observationStatus,Normal,,,,
E,measurementMethod,Estimated,,,,
P,measurementMethod,Provisional,,,,
F,measurementMethod,Forecast,,,,
OBS_STATUS:M,MissingValue,'',,,,
OBS_STATUS:NA,NotApplicable,'',,,,
```
