main:
  params: [args]
  steps:
    - init:
        assign:
          - projectId: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - region: ${sys.get_env("LOCATION")}
          - imageUri: ${default(map.get(args, "imageUri"), "gcr.io/datcom-ci/dc-import-executor:stable")}
          - jobId: ${text.replace_all(text.to_lower(text.substring(text.split(args.importName, ":")[1], 0, 50) + "-" + string(int(sys.now()))), "_", "-")}
          - importName: ${args.importName}
          - importConfig: ${default(map.get(args, "importConfig"), "{}")}
          - gcsMountBucket: ${sys.get_env("GCS_MOUNT_BUCKET")}
          - gcsImportBucket: ${sys.get_env("GCS_BUCKET_ID")}
          - gcsMountPath: "/tmp/gcs"
          - ingestionHelper: "spanner-ingestion-helper" 
          - functionUrl: ${"https://" + region + "-" + projectId + ".cloudfunctions.net/" + ingestionHelper}
          - startTime: ${sys.now()}
          - defaultResources:
              machine: "n2-standard-8"
              cpu: 8000
              memory: 32768
              disk: 100
          - resources: ${default(map.get(args, "resources"), defaultResources)}
    - runImportJob:
        try:
          call: googleapis.batch.v1.projects.locations.jobs.create
          args:
            parent: ${"projects/" + projectId + "/locations/" + region}
            jobId: ${jobId}
            body:
              allocationPolicy:
                instances:
                - policy:
                    machineType: ${resources.machine}
                    provisioningModel: "STANDARD"
                    bootDisk:
                      image: "projects/debian-cloud/global/images/family/debian-12"
                      size_gb: ${resources.disk}
                  installOpsAgent: true
              taskGroups:
                taskSpec:
                  volumes:
                    - gcs:
                        remotePath: ${gcsMountBucket}
                      mountPath: ${gcsMountPath}
                  computeResource:
                    cpuMilli: ${resources.cpu}
                    memoryMib: ${resources.memory}
                  runnables:
                    - container:
                        imageUri: ${imageUri}
                        commands:
                        - ${"--import_name=" + importName}
                        - ${"--import_config=" + importConfig}
                      environment:
                        variables:
                          IMPORT_NAME: ${importName}
                          BATCH_JOB_NAME: ${jobId}
                taskCount: 1
                parallelism: 1
              logsPolicy:
                destination: CLOUD_LOGGING
            connector_params:
              timeout: 604800 #7 days
              polling_policy:
                initial_delay: 60
                multiplier: 2
                max_delay: 600
          result: importJobResponse
        except:
          as: e
          steps:
            - updateImportStatus:
                call: http.post
                args:
                  url: ${functionUrl}
                  auth:
                    type: OIDC
                  body:
                    actionType: 'update_import_status'
                    jobId: ${jobId}
                    importName: ${importName}
                    status: 'FAILURE'
                    executionTime: ${int(sys.now() - startTime)}
                    latestVersion: ${"gs://" + gcsImportBucket + "/" + text.replace_all(importName, ":", "/")}
                result: functionResponse
            - failWorkflow:
                raise: ${e}
    - updateImportVersion:
        call: http.post
        args:
          url: ${functionUrl}
          auth:
            type: OIDC
          body:
            actionType: 'update_import_version'
            importName: ${importName}
            version: 'STAGING'
            override: false
            comment: '${"import-workflow:" + sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID")}'
        result: functionResponse
    - returnResult:
        return:
          jobId: ${jobId}
          importName: ${importName}